"use strict";"require view";"require poll";const API="/cgi-bin/huawei_hilink";const PoweredBy="Mutiara-Wrt";const E=(tag,attrs,children)=>{const el=document.createElement(tag);if(attrs)
for(const k in attrs){if(k==="class")el.className=attrs[k];else if(k==="style")el.setAttribute("style",attrs[k]);else el.setAttribute(k,attrs[k])}
if(children!=null){if(Array.isArray(children)){children.forEach((c)=>{if(c==null)return;el.append(c.nodeType?c:document.createTextNode(String(c)))})}else{el.append(children?.nodeType?children:document.createTextNode(String(children)))}}
return el};const T=(s)=>(typeof _==="function"?_(s):String(s??""));function luRes(path){try{return typeof L!=="undefined"&&L.resource?L.resource(path):path}catch(_e){return path}}
function num(v){if(v==null)return null;const m=String(v).match(/-?\d+/);return m?parseInt(m[0],10):null}
function clamp(x,a,b){return Math.max(a,Math.min(b,x))}
function pct(v,min,max){const n=num(v);if(n==null)return 0;const p=(n-min)/(max-min);return Math.round(clamp(p,0,1)*100)}
const pctRSSI=(v)=>pct(v,-110,-50);const pctRSRP=(v)=>pct(v,-120,-60);const pctSINR=(v)=>pct(v,-15,30);const pctRSRQ=(v)=>pct(v,-20,-5);const pctRSCP=(v)=>pct(v,-120,-60);const pctECIO=(v)=>pct(v,-20,-3);function qualityPercent(rssi){const n=num(rssi);if(n==null)return 0;const csq=clamp(Math.round((n+113)/2),0,31);return Math.round((csq/31)*100)}
function setBarColored(id,percent,titleText,color){const el=document.getElementById(id);if(!el)return;const p=percent|0;const title=titleText==null||titleText===""?"-":String(titleText);const fill=el.firstElementChild||el.querySelector("div");if(fill){fill.style.width=p+"%";fill.title=title;if(color)fill.style.background=color}
el.title=title}
function colorFromRSSI(v){const n=num(v);if(n==null)return"gray";if(n>-70)return"lime";if(n>=-85)return"yellow";if(n>=-100)return"darkorange";return"red"}
function colorFromRSRP(v){const n=num(v);if(n==null)return"gray";if(n>=-80)return"lime";if(n>=-90)return"yellow";if(n>=-100)return"darkorange";return"red"}
function colorFromSINR(v){const n=num(v);if(n==null)return"gray";if(n>20)return"lime";if(n>=13)return"yellow";if(n>0)return"darkorange";return"red"}
function colorFromRSRQ(v){const n=num(v);if(n==null)return"gray";if(n>=-10)return"lime";if(n>=-15)return"yellow";if(n>=-20)return"darkorange";return"red"}
function colorFromRSCP(v){const n=num(v);if(n==null)return"gray";if(n>=-80)return"lime";if(n>=-90)return"yellow";if(n>=-100)return"darkorange";return"red"}
function colorFromECIO(v){const n=num(v);if(n==null)return"gray";if(n>=-6)return"lime";if(n>=-10)return"yellow";if(n>=-13)return"darkorange";return"red"}
function tableRows(rows){return E("div",{class:"table"},rows)}
function trKVLeft(k,v){function asChild(x){if(x==null)return T("");if(typeof x==="string"||typeof x==="number")return T(String(x));if(Array.isArray(x))return x;return x}
return E("div",{class:"tr"},[E("div",{class:"td left",style:"width:33%"},T(k)),E("div",{class:"td left"},asChild(v))])}
function trProgress(id,title,sub){return E("div",{class:"tr"},[E("div",{class:"td left",style:"width:33%"},[T(title),sub!=null&&sub!==""?E("div",{style:"text-align:left;font-size:66%"},[T(sub)]):null]),E("div",{class:"td"},E("div",{id,class:"cbi-progressbar",title:"-"},E("div"))),])}
function trSignalImg(id,title,sub){return E("div",{class:"tr"},[E("div",{class:"td left",style:"width:33%"},[T(title),sub?E("div",{style:"text-align:left;font-size:66%"},[T(sub)]):null]),E("div",{class:"td left"},E("span",{id:id+"-wrap"},[E("span",{id:id+"-text",style:"margin-right:6px;"},"0%"),E("img",{id,src:luRes("icons/hilink-0.png"),style:"height:18px",title:"-"})])),])}
function iconFileFromPercent(pct){const p=Math.max(0,Math.min(100,pct|0));if(p===0)return"hilink-0.png";if(p<=20)return"hilink-0-20.png";if(p<=40)return"hilink-20-40.png";if(p<=60)return"hilink-40-60.png";if(p<=80)return"hilink-60-80.png";return"hilink-80-100.png"}
function setSignalImg(id,percent,titleText){const img=document.getElementById(id);const txt=document.getElementById(id+"-text");if(!img||!txt)return;const p=Math.max(0,Math.min(100,percent|0));img.src=luRes("icons/"+iconFileFromPercent(p));txt.textContent=p+"%";img.title=titleText==null||titleText===""?"-":String(titleText)}
const MODE_2G=0;const MODE_3G=2;const MODE_4G=7;function computeModeNameRaw(d){if(d&&typeof d.net_mode==="string"&&d.net_mode)return d.net_mode;switch(d?.dev_mode){case MODE_4G:return"LTE"+" | "+(d.band);case MODE_3G:return"3G";case MODE_2G:return"2G";default:return""}}
function computeModeName(d){const raw=(computeModeNameRaw(d)||"").toUpperCase();if(raw.startsWith("LTE")||raw==="7")return"LTE"+" | "+(d.band);if(raw.startsWith("3G")||raw==="2")return"HSPA";if(raw.startsWith("2G")||raw==="0")return"EDGE";return"-"}
const is4G=(d)=>computeModeName(d)==="LTE"+" | "+(d.band);const is3G=(d)=>computeModeName(d)==="3G";const is2G=(d)=>computeModeName(d)==="2G";function normalize(apiData){const n=apiData?.network||{};const c=apiData?.connection||{};const t=apiData?.traffic||{};const dv=apiData?.device||{};return{operator:n.operator??"-",plmn:n.plmn??"-",dev_mode:num(n.net_mode),net_mode:n.net_mode??"",pci:n.pci??"-",rssi:n.rssi??"-",rsrp:n.rsrp??"-",sinr:n.sinr??"-",rsrq:n.rsrq??"-",rscp:n.rscp??"-",ecio:n.ecio??"-",lac_dec:n.lac_dec??"-",lac_hex:n.lac_hex??"-",cell_id_dec:n.cell_id_dec??"-",cell_id_hex:n.cell_id_hex??"-",enb_rnc:n.enb_rnc??"-",cell_index:n.cell_index??"-",band:n.band??"-",earfcn_dl:n.earfcn_dl??"-",earfcn_ul:n.earfcn_ul??"-",bandwidth_dl_mhz:n.bw_dl??"-",bandwidth_ul_mhz:n.bw_ul??"-",freq_dl:n.freq_dl??"-",freq_ul:n.freq_ul??"-",sim_status:n.status??"-",connt_current:c.cconn??"-",connt_total:c.tconn??"-",connt:c.cconn??"-",connrx:c.crx??"-",conntx:c.ctx??"-",trx_total:c.trx??"-",ttx_total:c.ttx??"-",speedrx:t.rx??"-",speedtx:t.tx??"-",devicename:dv.model??"-",software_version:dv.software??"-",webui_version:dv.webui??"-",}}
function renderConnInfo(d){const elstat=document.getElementById("conn-stat");if(!elstat)return;const last=d.connt_current||"-";const total=d.connt_total||d.connt||"-";const crx=d.connrx||"-";const ctx=d.conntx||"-";const trx=d.trx_total||"-";const ttx=d.ttx_total||"-";const rxS=d.speedrx||"-";const txS=d.speedtx||"-";const sicon=luRes("icons/ctime.png");elstat.innerHTML=`<img src="${sicon}" style="width:16px;height:16px;vertical-align:middle;margin-right:4px"/>`+`${last}`+` | `+`▲ ${ctx} ▼ ${crx}`}
function SIMdata(d){if(String(d.sim_status)==="1"){return E("span",{},[E("img",{src:luRes("icons/sim1m.png"),style:"width:20px;height:auto;vertical-align:middle;margin-right:4px"}),T("Registered")])}
return E("span",{},[E("img",{src:luRes("icons/sim1m.png"),style:"width:20px;height:auto;vertical-align:middle;margin-right:4px"}),T("Not registered")])}
const EMPTY_DATA={plmn:"-",operator:"-",dev_mode:"-",net_mode:"-",pci:"-",rssi:"-",rsrp:"-",sinr:"-",rsrq:"-",rscp:"-",ecio:"-",lac_dec:"-",lac_hex:"-",cell_id_dec:"-",cell_id_hex:"-",enb_rnc:"-",cell_index:"-",earfcn_dl:"-",earfcn_ul:"-",bandwidth_dl_mhz:"-",bandwidth_ul_mhz:"-",band:"-",sim_status:"-",connt:"-",connt_current:"-",connt_total:"-",connrx:"-",conntx:"-",trx_total:"-",ttx_total:"-",speedrx:"-",speedtx:"-",devicename:"-",software_version:"-",webui_version:"-",};function renderAll(d,$top,$conn,$sig,$cell,$dev){const modeName=computeModeName(d);const scorePct=qualityPercent(d.rssi);$top.innerHTML="";const simBadge=E("span",{class:"ifacebadge",id:"simv",style:"visibility: hidden; max-width:3em; display: inline-block;"},[E("div",{class:"ifacebox-body"},[E("div",{class:"cbi-tooltip-container"},[E("img",{src:luRes("icons/sim1m.png"),style:"width:24px; height:auto; padding:0",title:T("")}),E("span",{class:"cbi-tooltip",style:"text-align:left;font-size:80%"},SIMdata(d)),]),]),]);const simRow=E("div",{class:"tr"},[E("div",{class:"td left",style:"width:33%"},[T("SIM status")]),E("div",{class:"td left"},[SIMdata(d)])]);$top.append(E("h3",{},T("General Information")),tableRows([trSignalImg("sigimg","Signal strength"),trKVLeft("Operator",d.operator||"-"),trKVLeft("PLMN",d.plmn||"-"),simRow,trKVLeft("Technology",modeName),trKVLeft("Connection Statistics",E("span",{id:"conn-stat"},"-")),]));setSignalImg("sigimg",scorePct,scorePct+"%");$dev.innerHTML="";$dev.append(E("h3",{},T("Device Information")),tableRows([trKVLeft("Device Model",d.devicename||"-"),trKVLeft("Software Version",d.software_version||"-"),trKVLeft("WebUI Version",d.webui_version||"-")]));$sig.innerHTML="";const modeTitle=modeName==="LTE"||modeName==="3G"?"Signal Information":"Signal";$sig.append(E("h3",{},T(modeTitle)));const sigRows=[];sigRows.push(trProgress("rssin","RSSI","(Received Signal Strength Indicator)"));if(is4G(d)){sigRows.push(trProgress("rsrpn","RSRP","(Reference Signal Receive Power)"));sigRows.push(trProgress("sinrn","SINR","(Signal to Interference plus Noise Ratio)"));sigRows.push(trProgress("rsrqn","RSRQ","(Reference Signal Received Quality)"))}else if(is3G(d)){sigRows.push(trProgress("rscpn","RSCP","(Received Signal Code Power)"));sigRows.push(trProgress("ecion","Ec/Io","(Energy per chip / Interference)"))}
$sig.append(tableRows(sigRows));setBarColored("rssin",pctRSSI(d.rssi),d.rssi??"-",colorFromRSSI(d.rssi));if(is4G(d)){setBarColored("rsrpn",pctRSRP(d.rsrp),d.rsrp??"-",colorFromRSRP(d.rsrp));setBarColored("sinrn",pctSINR(d.sinr),d.sinr??"-",colorFromSINR(d.sinr));setBarColored("rsrqn",pctRSRQ(d.rsrq),d.rsrq??"-",colorFromRSRQ(d.rsrq))}else if(is3G(d)){setBarColored("rscpn",pctRSCP(d.rscp),d.rscp??"-",colorFromRSCP(d.rscp));setBarColored("ecion",pctECIO(d.ecio),d.ecio??"-",colorFromECIO(d.ecio))}
$cell.innerHTML="";const cellRows=[];if(is4G(d)){cellRows.push(trKVLeft("PCI",d.pci??""));cellRows.push(trKVLeft("EARFCN (DL/UL)",(d.earfcn_dl??"")+((d.earfcn_ul??"")!==""?" / "+d.earfcn_ul:"")));cellRows.push(trKVLeft("Frequency (DL/UL)",(d.freq_dl??"")+((d.freq_ul??"")!==""?" / "+d.freq_ul:"")));cellRows.push(trKVLeft("Bandwidth (DL/UL)",((d.bandwidth_dl_mhz??"")!==""?d.bandwidth_dl_mhz+" MHz":"")+((d.bandwidth_ul_mhz??"")!==""?" / "+d.bandwidth_ul_mhz+" MHz":"")));cellRows.push(trKVLeft("LAC (hex/dec)",(d.lac_hex??"")+" / "+(d.lac_dec??"")));cellRows.push(trKVLeft("Cell ID (hex/dec)",(d.cell_id_hex??"")+" / "+(d.cell_id_dec??"")));cellRows.push(trKVLeft("eNB / Cell",d.enb_rnc!=null&&d.cell_index!=null?d.enb_rnc+" / "+d.cell_index:""))}else if(is3G(d)){cellRows.push(trKVLeft("LAC (hex/dec)",(d.lac_hex??"")+" / "+(d.lac_dec??"")));cellRows.push(trKVLeft("Cell ID (hex/dec)",(d.cell_id_hex??"")+" / "+(d.cell_id_dec??"")));cellRows.push(trKVLeft("RNC / CI",d.enb_rnc!=null&&d.cell_index!=null?d.enb_rnc+" / "+d.cell_index:""))}else{cellRows.push(trKVLeft("LAC (hex/dec)",(d.lac_hex??"")+" / "+(d.lac_dec??"")));cellRows.push(trKVLeft("Cell ID (hex/dec)",(d.cell_id_hex??"")+" / "+(d.cell_id_dec??"")))}
$cell.append(E("h3",{},T("Cell Information")),tableRows(cellRows));renderConnInfo(d)}
async function fetchData(){const r=await fetch(API,{cache:"no-store"});if(!r.ok)throw new Error("HTTP "+r.status);const j=await r.json();if(!j||!j.status||String(j.status).toLowerCase()!=="success")throw new Error("API error");return normalize(j.data||{})}
async function repaint($top,$conn,$sig,$cell,$alert,$dev){try{const d=await fetchData();$alert.style.display="none";renderAll(d,$top,$conn,$sig,$cell,$dev)}catch(_e){$alert.style.display=""}}
return view.extend({load:function(){return Promise.resolve()},render:function(){const root=E("div",{class:"cbi-map"},[E("div",{id:"hw-alert",class:"alert-message warning",style:"display:none"},T("Failed fetch data from API.")),E("div",{id:"card-top",class:"cbi-section"}),E("div",{id:"card-sig",class:"cbi-section"}),E("div",{id:"card-cell",class:"cbi-section"}),E("div",{id:"card-dev",class:"cbi-section"}),]);const $alert=root.querySelector("#hw-alert");const $top=root.querySelector("#card-top");const $conn=root.querySelector("#card-conn");const $sig=root.querySelector("#card-sig");const $cell=root.querySelector("#card-cell");const $dev=root.querySelector("#card-dev");renderAll(EMPTY_DATA,$top,$conn,$sig,$cell,$dev);repaint($top,$conn,$sig,$cell,$alert,$dev);poll.add(()=>repaint($top,$conn,$sig,$cell,$alert,$dev),3);return root},handleSaveApply:null,handleReset:null,handleSave:null,})