'use strict';'require view';'require request';'require ui';return view.extend({load:function(){return request.get('/cgi-bin/huawei_sms?op=list').then(function(res){return res.json()})},render:function(data){var self=this;var smsRaw=(data&&data.sms&&data.sms.messages)?data.sms.messages:[];var style=E('style',{},["#sms-section h3 { margin: 0 0 .25rem; padding-bottom: .25rem; border-bottom: 1px solid #e5e5e5; }",".toolbar { display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; margin-bottom:.5rem; }",".btn { border-radius:6px; margin-top: 0; margin-bottom: .5rem; }",".badge { padding:.1rem .4rem; border-radius:999px; font-size:.75rem; }",".badge.unread { background:#ffd8d8; color:#7a0000; }",".badge.read { background:#e6ffe6; color:#145214; }","table.sms-table { width:100%; border-collapse:collapse; }","table.sms-table th, table.sms-table td { padding:.5rem .6rem; border-bottom:1px solid #e5e5e5; vertical-align:top; }","table.sms-table th { text-align:left; font-weight:600; }","td.message { max-width:680px; white-space:normal; word-break:break-word; }",".cards { display:none; gap:.75rem; }",".card { border:1px solid #e5e5e5; border-radius:10px; padding:.6rem .75rem; box-shadow:0 1px 0 rgba(0,0,0,.03); }",".card .row { display:flex; align-items:center; justify-content:space-between; gap:.5rem; }",".card .meta { font-size:.85rem; opacity:.85; display:flex; gap:.5rem; flex-wrap:wrap; }",".card .msg { margin:.4rem 0; white-space:pre-wrap; word-break:break-word; }",".card .actions { display:flex; gap:.5rem; flex-wrap:wrap; }","/* empty state */",".empty-state { display:none; border:1px dashed #d0d0d0; border-radius:12px; padding:1rem; text-align:center; color:#666; background:#fafafa; }",".empty-state .title { font-weight:600; margin-bottom:.25rem; }",".empty-state .hint { font-size:.9rem; opacity:.9; }","/* responsive */","@media (max-width: 900px){ table.sms-table { display:none; } .cards { display:grid; } }","/* delete button merah */",".cbi-button.cbi-button-remove { background:#9b0000 !important; border-color:#9b0000 !important; color:#fff !important; }",".cbi-button.cbi-button-remove:hover { background:#d32f2f !important; border-color:#b71c1c !important; }",".cbi-button.cbi-button-remove:disabled { filter:grayscale(20%); opacity:.75; }","/* soft-loading */","#sms-section.is-loading { position:relative; }","#sms-section.is-loading::after { content:''; position:absolute; inset:0; pointer-events:none; background:linear-gradient(90deg, transparent 0%, rgba(0,0,0,.03) 50%, transparent 100%); animation: shimmer 1.2s infinite; opacity:.6; }","@keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }","/* highlight row baru */",".row-updated { animation: flash 900ms ease; }","@keyframes flash { from { background:#fff9c4; } to { background:transparent; } }"].join('\n'));function btn(label,onclick,cls,disabled){return E('button',{'class':'btn cbi-button '+(cls||''),'type':'button',click:onclick,disabled:disabled||null},label)}
function alertBox(title,message){ui.showModal(title||'Info',[E('p',{},message),E('div',{'class':'right'},[E('button',{'class':'btn',click:function(){ui.hideModal()}},'OK')])])}
function confirmBox(title,message,onYes){ui.showModal(title||'Confirm Action',[E('p',{},message),E('div',{'class':'right'},[E('button',{'class':'btn cbi-button-apply',click:function(){ui.hideModal();if(onYes)onYes();}},'Yes'),' ',E('button',{'class':'btn cbi-button-remove',click:function(){ui.hideModal()}},'Cancel')])])}
function apiRead(idxs,done){request.get('/cgi-bin/huawei_sms?op=read&index='+encodeURIComponent(idxs.join(','))).then(function(r){return r.json()}).then(function(j){if(!j.ok)return alertBox('Error','Failed to mark read: '+(j.error||'unknown'));if(done)done();}).catch(function(err){alertBox('Error',err)})}
function apiDelete(idxs,done){confirmBox('Confirm Action','Delete selected Message?',function(){request.get('/cgi-bin/huawei_sms?op=delete&index='+encodeURIComponent(idxs.join(','))).then(function(r){return r.json()}).then(function(j){if(!j.ok)return alertBox('Error','Failed to delete: '+(j.error||'unknown'));if(done)done();}).catch(function(err){alertBox('Error',err)})})}
function $all(sel,root){return Array.prototype.slice.call((root||document).querySelectorAll(sel))}
function getSelectedIdx(){return $all('.rowchk:checked').map(function(cb){return cb.getAttribute('data-index')})}
var refreshBtn=btn('Refresh',function(){refreshDataInto()},'cbi-button-apply');var bulkDelBtn=btn('Delete',function(){var sel=getSelectedIdx();if(!sel.length)return;apiDelete(sel,function(){refreshDataInto()})},'cbi-button-remove',!0);var toolbarSpin=E('img',{id:'spin',src:L.resource('icons/loading.gif'),style:'display:none; height:16px; width:16px; vertical-align:middle;'});var toolbar=E('div',{'class':'toolbar'},[refreshBtn,' ',bulkDelBtn,' ',toolbarSpin]);var table=E('table',{'class':'table cbi-section-table sms-table'},[E('tr',{'class':'tr table-titles'},[E('th',{'class':'th'},[E('input',{type:'checkbox',id:'chk-all',click:function(){$all('.rowchk').forEach(function(cb){cb.checked=document.getElementById('chk-all').checked});updateBulkButtonsState()}})]),E('th',{'class':'th center'},'Time'),E('th',{'class':'th center'},'From'),E('th',{'class':'th center'},'Message'),E('th',{'class':'th center'},'Status'),E('th',{'class':'th center'},'Action')])]);var cards=E('div',{'class':'cards'});var emptyState=E('div',{'class':'empty-state',id:'empty-state'},[E('div',{'class':'title'},'Belum ada pesan masuk'),E('div',{'class':'hint'},'klik "Refresh" untuk muat ulang.')]);var section=E('div',{'class':'cbi-section',id:'sms-section'},[style,E('h3',{},'Received Messages'),E('div',{'class':'cbi-section-descr'}),toolbar,table,cards,emptyState]);function mkRow(m){return E('tr',{'class':'tr','data-index':m.Index},[E('td',{'class':'td'},[E('input',{type:'checkbox','class':'rowchk','data-index':m.Index,change:updateBulkButtonsState})]),E('td',{'class':'td'},m.Date||''),E('td',{'class':'td'},m.Phone||''),E('td',{'class':'td message'},m.Content||''),E('td',{'class':'td'},[E('span',{'class':'badge '+(Number(m.Smstat)===1?'read':'unread')},Number(m.Smstat)===1?'Read':'Unread')]),E('td',{'class':'td'},[btn('Mark Read',function(){apiRead([m.Index],function(){refreshDataInto()})},'',Number(m.Smstat)===1),' ',btn('Delete',function(){apiDelete([m.Index],function(){refreshDataInto()})},'cbi-button-remove')])])}
function mkCard(m){return E('div',{'class':'card','data-index':m.Index},[E('div',{'class':'row'},[E('div',{'class':'meta'},[E('span',{},m.Date||''),E('span',{},m.Phone||'')]),E('label',{},[E('input',{type:'checkbox','class':'rowchk','data-index':m.Index,change:updateBulkButtonsState})])]),E('div',{'class':'msg'},m.Content||''),E('div',{'class':'row'},[E('span',{'class':'badge '+(Number(m.Smstat)===1?'read':'unread')},Number(m.Smstat)===1?'Read':'Unread'),E('div',{'class':'actions'},[btn('Mark Read',function(){apiRead([m.Index],function(){refreshDataInto()})},'',Number(m.Smstat)===1),btn('Delete',function(){apiDelete([m.Index],function(){refreshDataInto()})},'cbi-button-remove')])])])}
function updateBulkButtonsState(){var hasSel=getSelectedIdx().length>0;bulkDelBtn.disabled=!hasSel}
function clearRowsAndCards(){$all('tr.tr:not(.table-titles)',table).forEach(function(tr){tr.parentNode.removeChild(tr)});while(cards.firstChild)cards.removeChild(cards.firstChild);}
function renderList(list){var selected={};$all('.rowchk:checked').forEach(function(cb){selected[cb.getAttribute('data-index')]=!0});var isEmpty=!list||list.length===0;emptyState.style.display=isEmpty?'block':'none';table.style.display=isEmpty?'none':'';cards.style.display=isEmpty?'none':'';if(isEmpty){bulkDelBtn.disabled=!0;clearRowsAndCards();return}
clearRowsAndCards();var frag=document.createDocumentFragment();list.forEach(function(m){frag.appendChild(mkRow(m))});table.appendChild(frag);$all('.rowchk',table).forEach(function(cb){var k=cb.getAttribute('data-index');cb.checked=!!selected[k]});var cardFrag=document.createDocumentFragment();list.forEach(function(m){cardFrag.appendChild(mkCard(m))});cards.appendChild(cardFrag);$all('.rowchk',cards).forEach(function(cb){var k=cb.getAttribute('data-index');cb.checked=!!selected[k]});updateBulkButtonsState()}
renderList(smsRaw);var isRefreshing=!1;function setLoading(v){section.classList.toggle('is-loading',!!v);refreshBtn.disabled=!!v;toolbarSpin.style.display=v?'inline-block':'none';section.setAttribute('aria-busy',v?'true':'false')}
function rowSelectorByIndex(idx){return'tr.tr[data-index="'+String(idx)+'"]'}
function refreshDataInto(){if(isRefreshing)return;isRefreshing=!0;setLoading(!0);self.load().then(function(newData){var next=(newData&&newData.sms&&newData.sms.messages)?newData.sms.messages:[];var beforeMap={};$all('tr.tr[data-index]',table).forEach(function(tr){beforeMap[tr.getAttribute('data-index')]=!0});renderList(next);next.forEach(function(m){var tr=table.querySelector(rowSelectorByIndex(m.Index));if(tr&&!beforeMap[String(m.Index)]){tr.classList.add('row-updated');setTimeout(function(){tr.classList.remove('row-updated')},900)}})}).catch(function(err){alertBox('Error','Refresh failed: '+err)}).finally(function(){setLoading(!1);isRefreshing=!1})}
document.addEventListener('change',function(e){var t=e.target;if(t&&t.classList&&t.classList.contains('rowchk')){updateBulkButtonsState()}});return section},handleSaveApply:null,handleReset:null,handleSave:null})